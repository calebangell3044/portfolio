<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin | Caleb Angell</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .admin-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-lg);
    }
    
    .admin-box {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: var(--space-xl);
      width: 100%;
      max-width: 400px;
    }
    
    .admin-box h1 {
      font-family: var(--font-display);
      font-size: 1.8rem;
      margin-bottom: var(--space-md);
      text-align: center;
    }
    
    .admin-box p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: var(--space-lg);
      text-align: center;
    }
    
    .form-group {
      margin-bottom: var(--space-md);
    }
    
    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: var(--space-xs);
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-elevated);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-azure);
    }
    
    .form-group textarea {
      min-height: 300px;
      resize: vertical;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
    }
    
    .btn-full {
      width: 100%;
      justify-content: center;
    }
    
    .error-msg {
      color: var(--accent-rose);
      font-size: 0.85rem;
      margin-top: var(--space-sm);
      text-align: center;
    }
    
    .success-msg {
      color: #4ade80;
      font-size: 0.85rem;
      margin-top: var(--space-sm);
      text-align: center;
    }
    
    /* Editor Layout */
    .editor-container {
      max-width: 900px;
      width: 100%;
    }
    
    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
      flex-wrap: wrap;
      gap: var(--space-md);
    }
    
    .editor-header h1 {
      font-family: var(--font-display);
      font-size: 1.8rem;
      margin: 0;
    }
    
    .editor-actions {
      display: flex;
      gap: var(--space-sm);
    }
    
    .tag-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-elevated);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      min-height: 44px;
      align-items: center;
    }
    
    .tag-input-container input {
      flex: 1;
      min-width: 100px;
      padding: 4px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .tag-input-container input:focus {
      outline: none;
    }
    
    .tag-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(74, 144, 164, 0.2);
      color: var(--accent-azure);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    
    .tag-pill button {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      font-size: 1rem;
      line-height: 1;
      opacity: 0.7;
    }
    
    .tag-pill button:hover {
      opacity: 1;
    }
    
    /* Preview Panel */
    .preview-panel {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: var(--space-lg);
      margin-top: var(--space-lg);
    }
    
    .preview-panel h3 {
      font-family: var(--font-display);
      font-size: 1.2rem;
      margin-bottom: var(--space-md);
      color: var(--text-secondary);
    }
    
    .preview-content {
      color: var(--text-secondary);
      line-height: 1.8;
    }
    
    .preview-content h1, .preview-content h2, .preview-content h3 {
      font-family: var(--font-display);
      color: var(--text-primary);
      margin: var(--space-md) 0 var(--space-sm);
    }
    
    .preview-content p {
      margin-bottom: var(--space-md);
    }
    
    .preview-content strong {
      color: var(--text-primary);
    }
    
    .preview-content em {
      font-style: italic;
    }
    
    .preview-content a {
      color: var(--accent-azure);
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Settings toggle */
    .settings-toggle {
      background: none;
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }
    
    .settings-toggle:hover {
      border-color: rgba(255,255,255,0.2);
      color: var(--text-primary);
    }
    
    .settings-panel {
      background: var(--bg-elevated);
      border-radius: 8px;
      padding: var(--space-md);
      margin-bottom: var(--space-lg);
    }
    
    .settings-panel h4 {
      font-size: 0.9rem;
      margin-bottom: var(--space-sm);
      color: var(--text-secondary);
    }
    
    .repo-info {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }
    
    .repo-info input {
      flex: 1;
      min-width: 150px;
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="atmosphere"></div>
  <div class="stars"></div>
  
  <!-- Password Gate -->
  <div class="admin-container" id="passwordGate">
    <div class="admin-box">
      <h1>Admin Access</h1>
      <p>Enter password to continue</p>
      <form id="passwordForm">
        <div class="form-group">
          <input type="password" id="passwordInput" placeholder="Password" autocomplete="off">
        </div>
        <button type="submit" class="btn btn-primary btn-full">Enter</button>
        <p class="error-msg hidden" id="passwordError">Incorrect password</p>
      </form>
    </div>
  </div>
  
  <!-- PAT Setup -->
  <div class="admin-container hidden" id="patSetup">
    <div class="admin-box">
      <h1>GitHub Setup</h1>
      <p>Enter your GitHub Personal Access Token to enable publishing. <a href="https://github.com/settings/tokens/new?scopes=repo&description=Creative%20Hub%20Admin" target="_blank" style="color: var(--accent-azure);">Generate one here</a> with 'repo' scope.</p>
      <form id="patForm">
        <div class="form-group">
          <label>Personal Access Token</label>
          <input type="password" id="patInput" placeholder="ghp_xxxxxxxxxxxx">
        </div>
        <div class="form-group">
          <label>Repository (username/repo-name)</label>
          <input type="text" id="repoInput" placeholder="calebangell3044/creative-hub">
        </div>
        <button type="submit" class="btn btn-primary btn-full">Save & Continue</button>
        <p class="error-msg hidden" id="patError"></p>
      </form>
    </div>
  </div>
  
  <!-- Main Editor -->
  <div class="admin-container hidden" id="editorView">
    <div class="editor-container">
      <div class="editor-header">
        <h1>New Post</h1>
        <div class="editor-actions">
          <button class="settings-toggle" onclick="toggleSettings()">⚙️ Settings</button>
          <button class="btn" onclick="previewPost()">Preview</button>
          <button class="btn btn-primary" onclick="publishPost()" id="publishBtn">Publish</button>
        </div>
      </div>
      
      <div class="settings-panel hidden" id="settingsPanel">
        <h4>GitHub Settings</h4>
        <div class="repo-info">
          <input type="text" id="repoDisplay" placeholder="username/repo">
          <button class="btn" onclick="updateRepo()">Update</button>
          <button class="btn" onclick="clearCredentials()" style="border-color: var(--accent-rose); color: var(--accent-rose);">Clear All</button>
        </div>
      </div>
      
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="postTitle" placeholder="My Awesome Post">
      </div>
      
      <div class="form-group">
        <label>Tags (press Enter to add)</label>
        <div class="tag-input-container" id="tagContainer">
          <input type="text" id="tagInput" placeholder="Add tags...">
        </div>
      </div>
      
      <div class="form-group">
        <label>Content (Markdown supported)</label>
        <textarea id="postContent" placeholder="Write your post here...

You can use **bold**, *italic*, and [links](https://example.com).

## Headings work too

Just write naturally and it will be formatted nicely on your site."></textarea>
      </div>
      
      <p class="success-msg hidden" id="successMsg"></p>
      <p class="error-msg hidden" id="editorError"></p>
      
      <div class="preview-panel hidden" id="previewPanel">
        <h3>Preview</h3>
        <div class="preview-content" id="previewContent"></div>
      </div>
    </div>
  </div>
  
  <script>
    // Config
    const CORRECT_PASSWORD_HASH = '8f9b7c6d5e4a3b2c1d0e9f8a7b6c5d4e'; // We'll check against the actual password
    const STORAGE_KEYS = {
      authenticated: 'admin_auth',
      pat: 'github_pat',
      repo: 'github_repo'
    };
    
    let tags = [];
    
    // Password check (simple client-side - real security is the PAT)
    function checkPassword(input) {
      return input === '@Boy$dr3am#';
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Check if already authenticated this session
      if (sessionStorage.getItem(STORAGE_KEYS.authenticated)) {
        showPatOrEditor();
      }
      
      // Password form
      document.getElementById('passwordForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('passwordInput').value;
        if (checkPassword(password)) {
          sessionStorage.setItem(STORAGE_KEYS.authenticated, 'true');
          showPatOrEditor();
        } else {
          document.getElementById('passwordError').classList.remove('hidden');
          document.getElementById('passwordInput').value = '';
        }
      });
      
      // PAT form
      document.getElementById('patForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const pat = document.getElementById('patInput').value.trim();
        const repo = document.getElementById('repoInput').value.trim();
        
        if (!pat || !repo) {
          showError('patError', 'Please fill in all fields');
          return;
        }
        
        localStorage.setItem(STORAGE_KEYS.pat, pat);
        localStorage.setItem(STORAGE_KEYS.repo, repo);
        showEditor();
      });
      
      // Tag input
      document.getElementById('tagInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addTag(e.target.value.trim());
          e.target.value = '';
        }
      });
    });
    
    function showPatOrEditor() {
      document.getElementById('passwordGate').classList.add('hidden');
      
      const pat = localStorage.getItem(STORAGE_KEYS.pat);
      const repo = localStorage.getItem(STORAGE_KEYS.repo);
      
      if (pat && repo) {
        showEditor();
      } else {
        document.getElementById('patSetup').classList.remove('hidden');
      }
    }
    
    function showEditor() {
      document.getElementById('passwordGate').classList.add('hidden');
      document.getElementById('patSetup').classList.add('hidden');
      document.getElementById('editorView').classList.remove('hidden');
      document.getElementById('repoDisplay').value = localStorage.getItem(STORAGE_KEYS.repo) || '';
    }
    
    function showError(elementId, message) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.classList.remove('hidden');
    }
    
    function hideError(elementId) {
      document.getElementById(elementId).classList.add('hidden');
    }
    
    function toggleSettings() {
      document.getElementById('settingsPanel').classList.toggle('hidden');
    }
    
    function updateRepo() {
      const repo = document.getElementById('repoDisplay').value.trim();
      if (repo) {
        localStorage.setItem(STORAGE_KEYS.repo, repo);
        alert('Repository updated!');
      }
    }
    
    function clearCredentials() {
      if (confirm('This will clear your saved GitHub credentials. Continue?')) {
        localStorage.removeItem(STORAGE_KEYS.pat);
        localStorage.removeItem(STORAGE_KEYS.repo);
        sessionStorage.removeItem(STORAGE_KEYS.authenticated);
        location.reload();
      }
    }
    
    // Tags
    function addTag(tag) {
      if (tag && !tags.includes(tag)) {
        tags.push(tag);
        renderTags();
      }
    }
    
    function removeTag(tag) {
      tags = tags.filter(t => t !== tag);
      renderTags();
    }
    
    function renderTags() {
      const container = document.getElementById('tagContainer');
      const input = document.getElementById('tagInput');
      
      // Remove existing pills
      container.querySelectorAll('.tag-pill').forEach(el => el.remove());
      
      // Add new pills before input
      tags.forEach(tag => {
        const pill = document.createElement('span');
        pill.className = 'tag-pill';
        pill.innerHTML = `${tag} <button onclick="removeTag('${tag}')">&times;</button>`;
        container.insertBefore(pill, input);
      });
    }
    
    // Simple Markdown to HTML
    function markdownToHtml(md) {
      return md
        // Headers
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        // Bold and italic
        .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Links
        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
        // Paragraphs
        .replace(/\n\n/g, '</p><p>')
        .replace(/^(.+)$/gm, '<p>$1</p>')
        .replace(/<p><h/g, '<h')
        .replace(/<\/h(\d)><\/p>/g, '</h$1>')
        .replace(/<p><\/p>/g, '');
    }
    
    function previewPost() {
      const content = document.getElementById('postContent').value;
      const preview = document.getElementById('previewPanel');
      const previewContent = document.getElementById('previewContent');
      
      previewContent.innerHTML = markdownToHtml(content);
      preview.classList.toggle('hidden');
    }
    
    // Publish to GitHub
    async function publishPost() {
      const title = document.getElementById('postTitle').value.trim();
      const content = document.getElementById('postContent').value.trim();
      const btn = document.getElementById('publishBtn');
      
      if (!title || !content) {
        showError('editorError', 'Please fill in title and content');
        return;
      }
      
      hideError('editorError');
      document.getElementById('successMsg').classList.add('hidden');
      
      // Show loading state
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Publishing...';
      
      try {
        const pat = localStorage.getItem(STORAGE_KEYS.pat);
        const repo = localStorage.getItem(STORAGE_KEYS.repo);
        
        if (!pat || !repo) {
          throw new Error('GitHub credentials not found');
        }
        
        // Generate filename
        const date = new Date();
        const dateStr = date.toISOString().split('T')[0];
        const slug = title.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
        const filename = `_posts/${dateStr}-${slug}.md`;
        
        // Generate front matter
        const frontMatter = [
          '---',
          'layout: post',
          `title: "${title.replace(/"/g, '\\"')}"`,
          `date: ${date.toISOString()}`,
          tags.length ? `tags: [${tags.join(', ')}]` : null,
          '---',
          '',
          content
        ].filter(Boolean).join('\n');
        
        // Create file via GitHub API
        const response = await fetch(`https://api.github.com/repos/${repo}/contents/${filename}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${pat}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: `Add post: ${title}`,
            content: btoa(unescape(encodeURIComponent(frontMatter)))
          })
        });
        
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to publish');
        }
        
        // Success!
        document.getElementById('successMsg').textContent = `✓ Published! Your post will appear on the site in a minute or two.`;
        document.getElementById('successMsg').classList.remove('hidden');
        
        // Clear form
        document.getElementById('postTitle').value = '';
        document.getElementById('postContent').value = '';
        tags = [];
        renderTags();
        document.getElementById('previewPanel').classList.add('hidden');
        
      } catch (error) {
        showError('editorError', error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Publish';
      }
    }
  </script>
</body>
</html>
